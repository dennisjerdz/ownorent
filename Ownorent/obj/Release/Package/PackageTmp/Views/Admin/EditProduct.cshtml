@model Ownorent.Models.ProductTemplate
@using Ownorent.Models
@{
    ViewBag.Title = "Edit Product";
    ViewBag.bgColor = "#f8fafc";
}

@if (ViewBag.Message != null)
{
    <div class="row">
        <div class="col-md-12">
            <br />
            <div class="ownorent-alert alert alert-success">
                @Html.Raw(ViewBag.Message)
            </div>
        </div>
    </div>
}

<div class="row">
    <div class="col-md-offset-3 col-md-6">
        <div class="account-card">

            <div class="ownorent-header-internal">
                Edit Product: @Model.ProductName
            </div>

            <!--<center>
                <img src="~/Content/Images/logo.png" style="width:300px; transform:translate(0px)" />
            </center>-->

            @using (Html.BeginForm("EditProduct", "Admin", FormMethod.Post, new { @class = "form-horizontal", role = "form" }))
            {
                @Html.AntiForgeryToken()
                @Html.ValidationSummary("", new { @class = "text-danger" })
                @Html.HiddenFor(s => s.ProductTemplateId)

                <a class="ownorent-toggle" data-toggle="collapse" data-target="#general">General</a>

                <section id="general" class="collapse in">
                    <div class="form-group">
                        <div class="col-md-12">
                            @Html.LabelFor(m => m.Category, new { @class = "control-label" })
                            <select class="form-control category" name="CategoryId">
                                @if (ViewBag.CategoriesList != null)
                                {
                                    foreach (Category c in (List<Category>)ViewBag.CategoriesList)
                                    {
                                        <option value="@c.CategoryId" data-usefulLife="@c.UsefulLifeSpan">@c.CategoryName</option>
                                    }
                                }
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-md-12">
                            @Html.LabelFor(m => m.ProductName, new { @class = "control-label" })
                            @Html.TextBoxFor(m => m.ProductName, new { @class = "form-control" })
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-md-12">
                            @Html.LabelFor(m => m.ProductDescription, new { @class = "control-label" })
                            @Html.TextAreaFor(m => m.ProductDescription, new { @class = "form-control" })
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-md-6">
                            @Html.LabelFor(m => m.Quantity, new { @class = "control-label" })
                            @Html.TextBoxFor(m => m.Quantity, new { @class = "form-control", @type = "number", @step = "1" })
                        </div>

                        <div class="col-md-6">
                            <label class="control-label">Date Purchased (mm/dd/yyyy)</label>
                            @Html.TextBoxFor(m => m.DatePurchased, new { @class = "form-control", @type = "date", @max = DateTime.UtcNow.AddHours(8).ToString("yyyy-MM-dd") })
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-md-12">
                            @Html.LabelFor(m => m.TrackingNumber, new { @class = "control-label" })
                            @Html.TextBoxFor(m => m.TrackingNumber, new { @class = "form-control" })
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-md-6">
                            @Html.LabelFor(m => m.Price, new { @class = "control-label" })
                            @Html.TextBoxFor(m => m.Price, new { @class = "form-control", @type = "number", @step = ".01" })
                        </div>

                        <div class="col-md-6">
                            @Html.LabelFor(m => m.DailyRentPrice, new { @class = "control-label" })
                            @Html.TextBoxFor(m => m.DailyRentPrice, new { @class = "form-control", @type = "number", @step = ".01" })
                        </div>
                    </div>
                </section>

                <hr />

                <a class="ownorent-toggle" data-toggle="collapse" data-target="#admin">Admin</a>

                <section id="admin" class="collapse in">
                    <div class="form-group">
                        <div class="col-md-12">
                            @Html.LabelFor(m => m.ProductPriceToUse, new { @class = "control-label" })
                            <select class="form-control category" name="ProductPriceToUse">
                                @if (Model.ProductPriceToUse == ProductPriceToUseConstant.SELLER_DEFINED_PRICE)
                                {
                                    <option value="@ProductPriceToUseConstant.SELLER_DEFINED_PRICE" selected>Seller Price</option>
                                }
                                else
                                {
                                    <option value="@ProductPriceToUseConstant.SELLER_DEFINED_PRICE">Seller Price</option>
                                }

                                @if (Model.ProductPriceToUse == ProductPriceToUseConstant.COMPUTED_PRICE)
                                {
                                    <option value="@ProductPriceToUseConstant.COMPUTED_PRICE" selected>Computed Price</option>
                                }
                                else
                                {
                                    <option value="@ProductPriceToUseConstant.COMPUTED_PRICE">Computed Price</option>
                                }
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-md-12">
                            <label class="control-label">Owner</label>
                            <input class="form-control" value="@Model.User.FirstName @Model.User.LastName - @Model.User.UserName" readonly/>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-md-6">
                            @Html.LabelFor(m => m.ShippingFee, new { @class = "control-label" })
                            @Html.TextBoxFor(m => m.ShippingFee, new { @class = "form-control", @type = "number", @step = ".01" })
                        </div>

                        <div class="col-md-6">
                            @Html.LabelFor(m => m.ShippingFeeProvincial, new { @class = "control-label" })
                            @Html.TextBoxFor(m => m.ShippingFeeProvincial, new { @class = "form-control", @type = "number", @step = ".01" })
                        </div>
                    </div>
                </section>

                <hr />

                <a class="ownorent-toggle" data-toggle="collapse" data-target="#compute">More Info ...</a>

                <section id="compute" class="collapse">
                    <div class="form-group">
                        <div class="col-md-12">
                            <p class="parameters ownorent-text-gray"></p>
                            <p class="formula ownorent-text-gray"></p>
                            <p class="note ownorent-text-gray"></p>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-md-6">
                            <label>Depreciated Price <br />(based on Shelf life)</label>
                            @Html.TextBoxFor(m => m.ComputedPrice, new { @class = "form-control", @type = "number", @step = ".01", @readonly = "true" })
                        </div>

                        <div class="col-md-6">
                            <label>Depreciated Rent Price <br />(based on Shelf life)</label>
                            @Html.TextBoxFor(m => m.ComputedDailyRentPrice, new { @class = "form-control", @type = "number", @step = ".01", @readonly = "true" })
                        </div>
                    </div>
                </section>

                <div class="form-group">
                    <div class="col-md-12">
                        <label class="control-label">Warehouse</label>
                        @Html.DropDownList("WarehouseId", null, htmlAttributes: new { @class = "form-control", @readonly = "true" })
                    </div>
                </div>

                <div class="form-group">
                    <div class="col-md-12">
                        <br />
                        <input type="submit" class="btn btn-info btn-block" value="Save" />
                        <br />
                        <center>
                            <p class="ownorent-text-orange">
                                All new products are subject for approval.
                            </p>
                            <p class="ownorent-text-orange">
                                Upon creation, please ship your product to selected warehouse <br /> and fill out Tracking Number field with what your courier provided.
                            </p>
                        </center>
                        <br />
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section scripts {
    <script>
        function dateDiff(dt1, dt2) {
            /*
             * setup 'empty' return object
             */
            var ret = { days: 0, months: 0, years: 0 };

            /*
             * If the dates are equal, return the 'empty' object
             */
            if (dt1 == dt2) return ret;

            /*
             * ensure dt2 > dt1
             */
            if (dt1 > dt2) {
                var dtmp = dt2;
                dt2 = dt1;
                dt1 = dtmp;
            }

            /*
             * First get the number of full years
             */

            var year1 = dt1.getFullYear();
            var year2 = dt2.getFullYear();

            var month1 = dt1.getMonth();
            var month2 = dt2.getMonth();

            var day1 = dt1.getDate();
            var day2 = dt2.getDate();

            /*
             * Set initial values bearing in mind the months or days may be negative
             */

            ret['years'] = year2 - year1;
            ret['months'] = month2 - month1;
            ret['days'] = day2 - day1;

            /*
             * Now we deal with the negatives
             */

            /*
             * First if the day difference is negative
             * eg dt2 = 13 oct, dt1 = 25 sept
             */
            if (ret['days'] < 0) {
                /*
                 * Use temporary dates to get the number of days remaining in the month
                 */
                var dtmp1 = new Date(dt1.getFullYear(), dt1.getMonth() + 1, 1, 0, 0, -1);

                var numDays = dtmp1.getDate();

                ret['months'] -= 1;
                ret['days'] += numDays;

            }

            /*
             * Now if the month difference is negative
             */
            if (ret['months'] < 0) {
                ret['months'] += 12;
                ret['years'] -= 1;
            }

            return ret;
        }

        $(document).ready(function () {

            var setDatePurchased = "@Model.DatePurchased.ToString("yyyy-MM-dd")";

            $("#DatePurchased").val(setDatePurchased);

            // trigger change function
            $(".category").change();

            var salvageValuePercent = @ViewBag.salvageValue;
            var salvageRentValuePercent = @ViewBag.salvageRentValue;
            var dailyRentPercentage = @ViewBag.dailyRentPercentage;

            $(".category").change(function () {
                compute();
            });

            $("#Price").keyup(function() {
                compute();
            });

            $("#DatePurchased").change(function() {
                compute();
            });

            function compute(){
                var price = $("#Price").val();
                var dailyrentprice = $("#DailyRentPrice").val();
                var datePurchasedText = $("#DatePurchased").val();
                var usefulLife = $(".category").find("option:selected").data("usefullife");

                if(price != "" && usefulLife != "" && datePurchasedText != ""){
                    var datePurchased = new Date(datePurchasedText);
                    var dateNow = new Date();

                    var difference = dateDiff(datePurchased, dateNow);

                    var differenceInYears = (difference.years + (difference.months/12) + ((difference.days/30)/10));
                    var differenceInYearsFinal = Math.round((differenceInYears + Number.EPSILON) * 100) / 100;

                    var salvageValue = (price*(salvageValuePercent/100));
                    var salvageValueFinal = Math.round((salvageValue + Number.EPSILON) * 100) / 100;

                    var salvageRentValue = price*(salvageRentValuePercent/100);
                    var salvageRentValueFinal = Math.round((salvageRentValue + Number.EPSILON) * 100) / 100;

                    var annualDepreciation = (price - salvageValue) / usefulLife;
                    var computedPrice = price-(annualDepreciation*differenceInYearsFinal);
                    var computedPriceFinal = Math.round((computedPrice + Number.EPSILON) * 100) / 100;

                    var computedDailyRentPrice = (computedPrice * (dailyRentPercentage/100));
                    var computedDailyRentPriceFinal = Math.round((computedDailyRentPrice + Number.EPSILON) * 100) / 100;

                    if(computedPrice < salvageValue){
                        $("#ComputedPrice").val(salvageValueFinal);
                        $("#ComputedDailyRentPrice").val(salvageRentValueFinal);
                    }else{
                        $("#ComputedPrice").val(computedPriceFinal);
                        $("#ComputedDailyRentPrice").val(computedDailyRentPriceFinal);
                    }

                    $(".parameters").html("Useful Life: "+usefulLife+", Years after purchase: "+differenceInYearsFinal+", Salvage Value: Price * "+salvageRentValuePercent+"% = "+salvageValueFinal+", Rent Percentage: "+dailyRentPercentage);
                    $(".formula").html("Computed Price: "+price+" - ((("+price + " - " + salvageValueFinal +") / "+usefulLife+") * "+differenceInYearsFinal+") = "+computedPriceFinal);
                    $(".formula").append("<br/> Computed Daily Rent Price: "+computedPriceFinal + " * " + dailyRentPercentage+"% = "+computedDailyRentPriceFinal);
                    $(".note").html("If the product exceeds shelf life, the Salvage Value is used.");

                    $('#compute').collapse('show');
                }
            }
        });
    </script>
}